/**********************************************************************************
// MAEVARM M4 STM32F373 OV7670 configuration
// date: March, 2013
// author: Chao Liu (chao.liu0307@gmail.com), modified other's register configuration
***********************************************************************************/

#include "ov7660.h"

const unsigned char ov7670_regs[][2] = 
 {
 	{0x8c, 0x00},  //REG_RGB444
	{0x15, 0x02},  //REG_COM10 //!!!!!!!!!!!!!!!!!!!!!!!
	{0x1e, 0x27},  //REG_MVFP
	{0x11, 0x80},  //REG_CLKRC
	{0x6b, 0x0a},  //DBLV
	{0x3b, 0x0a},  //REG_COM11
	{0x3a, 0x04},  //TSLB//Means the same as 0x00
	{0x3d, 0x88},  //REG_COM13
	{0x11, 0x03},  //REG_CLKRC
	{0x3a, 0x04},  //REG_TSLB
	{0x12, 0x01},  //REG_COM7
	{0x6b, 0x4a},  //DBLV
	{0x0c, 0x00},  //REG_COM3
	{0x3e, 0x00},  //REG_COM14
	{0x17, 0x13},  //REG_HSTART //!!!!!!!!!!!!!!!!!!!!!
	{0x18, 0x01},  //REG_HSTOP  //!!!!!!!!!!!!!!!!!!!!!F
	{0x32, 0xb6},  //REG_HREF //!!!!!!!!!!!!!!!!!!!!!!!
	{0x19, 0x02},  //REG_VSTART
	{0x1a, 0x7a},  //REG_VSTOP //slightly different
	{0x03, 0x0a},  //REG_VREF //!!!!!!!!!!!!!!!!!!!
	{0x72, 0x11},
	{0x73, 0xf0},
	{0x7a, 0x20},
	{0x7b, 0x10},
	{0x7c, 0x1e},
	{0x7d, 0x35},
	{0x7e, 0x5a},
	{0x7f, 0x69},
	{0x80, 0x76},
	{0x81, 0x80},
	{0x82, 0x88},
	{0x83, 0x8f},
	{0x84, 0x96},
	{0x85, 0xa3},
	{0x86, 0xaf},
	{0x87, 0xc4},
	{0x88, 0xd7},
	{0x89, 0xe8},
    
	/* AGC and AEC parameters.  Note we start by disabling those features,
	   then turn them only after tweaking the values. */
	{0x13, 0x80 | 0x40 | 0x20},  //!!!!!!!!!!!!wierd stuff
	{0x00, 0},  //!!!!!!!!!!!!!!!!!!!!!
	{0x10, 0},  //!!!!!!!!!!!!!!!!!!!!!
	{0x0d, 0x40},//!!!!!!!!!!!!!!!!!!!!!
	{0x14, 0x18},//!!!!!!!!!!!!!!!!!!!!!
	{0xa5, 0x05},
	{0xab, 0x07},
	{0x24, 0x95},//!!!!!!!!!!!!!!!!!!!!
	{0x25, 0x33},//!!!!!!!!!!!!!!!!!!!!
	{0x26, 0xe3},//!!!!!!!!!!!!!!!!!!!!
	{0x9f, 0x78},
	{0xa0, 0x68},
	{0xa1, 0x03},
	{0xa6, 0xd8},//!!!!!!!!!!!!!!!!!!!!
	{0xa7, 0xd8},
	{0xa8, 0xf0},
	{0xa9, 0x90},
	{0xaa, 0x94},
	{0x13, 0x80|0x40|0x20|0x04|0x01}, //more werd stuff
    
	/* Almost all of these are magic "reserved" values.  */
	{0x0e, 0x61},
	{0x0f, 0x4b},
	{0x16, 0x02},
	{0x1e, 0x27},
	{0x21, 0x02},
	{0x22, 0x91},
	{0x29, 0x07},
	{0x33, 0x0b},
	{0x35, 0x0b},
	{0x37, 0x1d},
	{0x38, 0x71},
	{0x39, 0x2a},
	{0x3c, 0x78},
	{0x4d, 0x40},
	{0x4e, 0x20},
	{0x69, 0}, //!!!!!!!!!!!!!!!!!!!!!!
	{0x6b, 0x0a},//!!!!!!!!!!!!!!!!!!!!!imp
	{0x74, 0x10},//!!!!!!!!!!!!!!!
	{0x8d, 0x4f},
	{0x8e, 0},
	{0x8f, 0},
	{0x90, 0},
	{0x91, 0},
	{0x96, 0},
	{0x9a, 0},
	{0xb0, 0x84},
	{0xb1, 0x0c},
	{0xb2, 0x0e},
	{0xb3, 0x82},
	{0xb8, 0x0a},
    
	/* More reserved magic, some of which tweaks white balance */
	{0x43, 0x0a},
	{0x44, 0xf0},
	{0x45, 0x34},
	{0x46, 0x58},
	{0x47, 0x28},
	{0x48, 0x3a},
	{0x59, 0x88},
	{0x5a, 0x88},
	{0x5b, 0x44},
	{0x5c, 0x67},
	{0x5d, 0x49},
	{0x5e, 0x0e},
	{0x6c, 0x0a},
	{0x6d, 0x55},
	{0x6e, 0x11},
	{0x6f, 0x9f},
	{0x6a, 0x40},
	{0x01, 0x40},
	{0x02, 0x60}, //!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
	{0x13, 0x80|0x40|0x20|0x04|0x01|0x02}, //again wierd stuff
    
	/* Matrix coefficients */
	{0x4f, 0x80},
	{0x50, 0x80},
	{0x51, 0},
	{0x52, 0x22},
	{0x53, 0x5e},
	{0x54, 0x80},
	{0x58, 0x9e},
    
	{0x41, 0x08},
	{0x3f, 0},
	{0x75, 0x05},
	{0x76, 0xe1},
	{0x4c, 0},
	{0x77, 0x01},
	{0x3d, 0xc3},
	{0x4b, 0x09},
	{0xc9, 0x60},
	{0x41, 0x38},
	{0x56, 0x40},
    
	{0x34, 0x11},
	{0x3b, 0x02|0x10},
	{0xa4, 0x88},
	{0x96, 0},
	{0x97, 0x30},
	{0x98, 0x20},
	{0x99, 0x30},
	{0x9a, 0x84},
	{0x9b, 0x29},
	{0x9c, 0x03},
	{0x9d, 0x4c},
	{0x9e, 0x3f},
	{0x78, 0x04},
     
	/* Extra-weird stuff.  Some sort of multiplexor register */
	{0x79, 0x01},
	{0xc8, 0xf0},
	{0x79, 0x0f},
	{0xc8, 0x00},
	{0x79, 0x10},
	{0xc8, 0x7e},
	{0x79, 0x0a},
	{0xc8, 0x80},
	{0x79, 0x0b},
	{0xc8, 0x01},
	{0x79, 0x0c},
	{0xc8, 0x0f},
	{0x79, 0x0d},
	{0xc8, 0x20},
	{0x79, 0x09},
	{0xc8, 0x80},
	{0x79, 0x02},
	{0xc8, 0xc0},
	{0x79, 0x03},
	{0xc8, 0x40},
	{0x79, 0x05},
	{0xc8, 0x30},
	{0x79, 0x26},
     
	{0xff, 0xff},







// {0x12,0x80},
// {0x11,0x01},// I changed from 01 to 03
// {0x3a,0x04},
// {0x12,0x01},
// {0x17,0x12},
// {0x18,0x00},
// {0x32,0xb6},
// {0x19,0x02},
// {0x1a,0x7a},
// {0x03,0x00},
// {0x0c,0x00},
// {0x3e,0x00},
// {0x70,0x3a},
// {0x71,0x35},
// {0x72,0x11},
// {0x73,0xf0},
// {0xa2,0x02},
// {0x13,0xe0},
// {0x00,0x00},
// {0x10,0x00},
// {0x0d,0x40},
// {0x14,0x38},
// {0xa5,0x07},
// {0xab,0x08},
// {0x24,0x95},
// {0x25,0x33},
// {0x26,0xe3},
// {0x9f,0x78},
// {0xa0,0x68},
// {0xa1,0x0b},
// {0xa6,0xd8},
// {0xa7,0xd8},
// {0xa8,0xf0},
// {0xa9,0x90},
// {0xaa,0x94},
// {0x13,0xe5},
// {0x0e,0x61},
// {0x0f,0x4b},
// {0x16,0x02},
// {0x21,0x02},
// {0x22,0x91},
// {0x29,0x07},
// {0x33,0x03},
// {0x35,0x0b},
// {0x37,0x1c},
// {0x38,0x71},
// {0x3c,0x78},
// {0x3d,0x08},
// {0x41,0x3a},
// {0x4d,0x40},
// {0x4e,0x20},
// {0x69,0x55},
// {0x6b,0x4a},//I changed from 4a to 0a
// {0x74,0x19},
// {0x76,0x61},
// {0x8d,0x4f},
// {0x8e,0x00},
// {0x8f,0x00},
// {0x90,0x00},
// {0x91,0x00},
// {0x96,0x00},
// {0x9a,0x80},
// {0xb0,0x8c},
// {0xb1,0x0c},
// {0xb2,0x0e},
// {0xb3,0x82},
// {0xb8,0x0a},
// {0x43,0x14},
// {0x44,0xf0},
// {0x45,0x34},
// {0x46,0x58},
// {0x47,0x28},
// {0x48,0x3a},
// {0x59,0x88},
// {0x5a,0x88},
// {0x5b,0x44},
// {0x5c,0x67},
// {0x5d,0x49},
// {0x5e,0x0e},
// {0x6c,0x0a},
// {0x6d,0x55},
// {0x6e,0x11},
// {0x6f,0x9f},
// {0x6a,0x40},
// {0x01,0x00},
// {0x02,0x00},//changed red gain from 0x40 to 0xff
// {0x13,0xe7},
// {0x34,0x11},
// {0x92,0x66},
// {0x3b,0x0a},
// {0xa4,0x88},
// {0x96,0x00},
// {0x97,0x30},
// {0x98,0x20},
// {0x99,0x20},
// {0x9a,0x84},
// {0x9b,0x29},
// {0x9c,0x03},
// {0x9d,0x4c},
// {0x9e,0x3f},
// {0x78,0x04},
// {0x79,0x01},
// {0xc8,0xf0},
// {0x79,0x0f},
// {0xc8,0x20},
// {0x79,0x10},
// {0xc8,0x7e},
// {0x79,0x0b},
// {0xc8,0x01},
// {0x79,0x0c},
// {0xc8,0x07},
// {0x79,0x0d},
// {0xc8,0x20},
// {0x79,0x09},
// {0xc8,0x80},
// {0x79,0x02},
// {0xc8,0xc0},
// {0x79,0x03},
// {0xc8,0x40},
// {0x79,0x05},
// {0xc8,0x3},
// {0x79,0x26},






 	//////////////////////////////////////////////
 //    {0x3a, 0x00},  //DD?o3?2a¨º?????
	// {0x40, 0xe0},  //??¨ª¡§????14
	// {0x12, 0x11},  //¨ª¡§¨®?????7COM7	0X11
 //     //{0x12, 0x00},
	// {0x32, 0x80},  //HREF???? //changed from 80 to b6 made image REALLY BAD
	// {0x17, 0x13},   //HSTART //changed this from 16 to 13 made image slightly more better 
	// {0x18, 0x01},  //HSTOP //changed this from 04 to 01 made image slightly more better 
	// {0x19, 0x02},  //VSTART
	// {0x1a, 0x7b},  //VSTOP,0x7a,//changed from 7b to 7a
	// {0x03, 0x06},  //VREF,0x0a,	//changed from 06 to 0a		
	// {0x0c, 0x00},  //COM3       10   //default setting		   //10
	// {0x3e, 0x00},  //COM14           //default setting
	// {0x70, 0x00},  //SCALING_XSC
	// {0x71, 0x01},  //SCALING_YSC
	// {0x72, 0x11},  //SCALING_DCWCTR    //default setting
	// {0x73, 0x00},  //SCALING_PC        //default setting
	// {0xa2, 0x02},  //SCALING_PCLK_DELAY  //default setting
	// {0x11, 0x83},  //{0x11, 0x81},  //CLKRC,2¡¤??¦Ì
	// {0x7a, 0x20},  //SLOP
	// {0x7b, 0x1c},  //GAM1
	// {0x7c, 0x28},  //GAM2                                     //20
	// {0x7d, 0x3c},  //GAM3
	// {0x7e, 0x55},  //GAM4
	// {0x7f, 0x68},  //GAM5
	// {0x80, 0x76},  //GAM6
	// {0x81, 0x80},  //GAM7
	// {0x82, 0x88},  //GAM8
	// {0x83, 0x8f},  //GAM9
	// {0x84, 0x96},  //GAM10
	// {0x85, 0xa3},  //GAM11
	// {0x86, 0xaf},  //GAM12                                    // 30
	// {0x87, 0xc4},  //GAM13
	// {0x88, 0xd7},  //GAM14
	// {0x89, 0xe8},  //GAM15
 //    {0x13, 0xe0},  //COM8
	// {0x00, 0x0f},  //AGC //Set to 00 from 0f didnt do anything
	// {0x10, 0x40},  //AECH	 00	 ??? //set to 00 from 40 didnt do anything
	// {0x0d, 0x00},  //COM4//default setting changed from 00 to 40
	// {0x14, 0x38},  //0x38, limit the max gain changed from 38 to 18
	// {0xa5, 0x05},  //BD50MAX
	// {0xab, 0x07},  //BD60MAX                                  //40
	// {0x24, 0x95},   //AEW//changed from 75 to 95
	// {0x25, 0x33},   //AEB//changed from 63 to 33
	// {0x26, 0xe3},   //VPT//changed from a5 to e3
	// {0x9f, 0x78},   //HAECC1 ff ???
	// {0xa0, 0x68},   //HAECC2 ff
	// {0xa1, 0x03},   //RSVD,0x0b,
	// {0xa6, 0xdf},   //HAECC3,0xd8, ff
	// {0xa7, 0xdf},   //HAECC4,0xd8, ff
	// {0xa8, 0xf0},   //HAECC5 ff
	// {0xa9, 0x90},   //HAECC6  ff                             //50
	// {0xaa, 0x94},   //HAECC7
	// {0x13, 0xe5},   //COM8
	// {0x0e, 0x61},   //COM5
	// {0x0f, 0x4b},   //COM6
	// {0x16, 0x02},    //RSVD
	// {0x1e, 0x07},    //MVFP,0x07,07
	// {0x21, 0x02},    //ADCCTR1
	// {0x22, 0x91},    //ADCCTR2
	// {0x23, 0x00},    //ADCCTR2
	// {0x29, 0x07},    //RSVD                            //60
	// {0x33, 0x0b},    //CHLF
	// {0x35, 0x0b},    //RSVD
	// {0x37, 0x1d},    //ADC
	// {0x38, 0x71},    //ACOM
	// {0x39, 0x2a},   //OFON
	// {0x3c, 0x78},   //COM12       65
	// {0x4d, 0x40},   //RSVD
	// {0x4e, 0x20},   //RSVD
	// {0x69, 0x00},   //GFIX//changed from 5d to 0
	// {0x6b, 0x6a},   //DBLV,PLL=inX4	          //changed from 60 to        //70
	// {0x74, 0x10},   //REG4//changed from 19 to 10
	// {0x8d, 0x4f},   //RSVD
	// {0x8e, 0x00},   //RSVD
	// {0x8f, 0x00},   //RSVD
	// {0x90, 0x00},   //RSVD
	// {0x91, 0x00},   //RSVD
	// {0x92, 0x00},   //DW_LNL,0x19,//0x66
	// {0x96, 0x00},   //RSVD
	// {0x9a, 0x80},   //RSVD
	// {0xb0, 0x84},   //RSVD	                     //80
	// {0xb1, 0x0c},   //ABLC1
	// {0xb2, 0x0e},   //RSVD
	// {0xb3, 0x82},   //THL_DLT
	// {0xb8, 0x0a},   //RSVD	                    //84
	// {0x43, 0x14},   //AWBC1
	// {0x44, 0xf0},   //AWBC2
	// {0x45, 0x34},   //AWBC3
	// {0x46, 0x58},   //AWBC4
	// {0x47, 0x28},   //AWBC5
	// {0x48, 0x3a},   //AWBC6
	// {0x59, 0x88},   //RSVD
	// {0x5a, 0x88},   //RSVD
	// {0x5b, 0x44},   //RSVD
	// {0x5c, 0x67},   //RSVD
	// {0x5d, 0x49},   //RSVD
	// {0x5e, 0x0e},   //RSVD
	// {0x64, 0x04},   //LCC3
	// {0x65, 0x20},   //LCC4
	// {0x66, 0x05},   //LCC5
	// {0x94, 0x04},   //LCC6
	// {0x95, 0x08},   //LCC7           100
	// {0x6c, 0x0a},   //AWBCTR3
	// {0x6d, 0x55},   //AWBCTR2
	// {0x6e, 0x11},   //AWBCTR1
	// {0x6f, 0x9f},	 //AWBCTR0,0x9e for advance AWB
	// {0x6a, 0x40},   //GGAIN
	// {0x01, 0x40},   //BLUE
	// {0x02, 0x40},   //RED 
	// {0x13, 0xe7},   //COM8
	// {0x15, 0x02},   //COM10 //I changed from 00 to 02 //made image kind of sharper, better
	// {0x2d, 0x00},
	//  /* Color Matrix */
	// {0x4f, 0x80},   //MTX1
	// {0x50, 0x80},   //MTX2
	// {0x51, 0x00},   //MTX3
	// {0x52, 0x22},   //MTX4
	// {0x53, 0x5e},   //MTX5
	// {0x54, 0x80},   //MTX6
 //    {0x55, 0x00},   //¨¢¨¢?¨¨//default setting
 //    {0x56, 0x52},   //??¡À¨¨?¨¨
 //    {0x58, 0x9e},	//MTXS 
	// {0x41, 0x08},   //COM16 
	// {0x3f, 0x05},   //¡À??¦Ì????¦Ì¡Â??
	// {0x75, 0x05},   //REG75
	// {0x76, 0xe1},   //REG76
	// {0x4c, 0x0F},   //??¨¦¨´¨°??????¨¨
	// {0x77, 0x0a},   //REG77
	// {0x3d, 0xc2},	//0xc0,
	// {0x4b, 0x09},   //REG4B
	// {0xc9, 0x60},   //SATCTR
	// {0x41, 0x38},    //COM16 
	// {0x56, 0x40},    //0x40,  change according to Jim's request	
	// {0x34, 0x11},    //ARBLM
	// {0x3b, 0x02},    //COM11,0x00,//0x02,
	// {0xa4, 0x89},    //0x88,
	// {0x96, 0x00},    //RSVD 
	// {0x97, 0x30},    //RSVD
	// {0x98, 0x20},    //RSVD                135
	// {0x99, 0x30},    //RSVD
	// {0x9a, 0x84},    //RSVD
	// {0x9b, 0x29},    //RSVD
	// {0x9c, 0x03},    //RSVD
	// {0x9d, 0x4c},    //BD50ST
	// {0x9e, 0x3f},    //BD60ST
	// {0x78, 0x04},	 //RSVD
	// {0x79, 0x01},    //RSVD
	// {0xc8, 0xf0},    //RSVD
	// {0x79, 0x0f},    //RSVD
	// {0xc8, 0x00},    //RSVD
	// {0x79, 0x10},    //RSVD
	// {0xc8, 0x7e},    //RSVD
	// {0x79, 0x0a},    //RSVD
	// {0xc8, 0x80},    //RSVD
	// {0x79, 0x0b},    //RSVD
	// {0xc8, 0x01},    //RSVD
	// {0x79, 0x0c},    //RSVD
	// {0xc8, 0x0f},    //RSVD
	// {0x79, 0x0d},    //RSVD
	// {0xc8, 0x20},    //RSVD
	// {0x79, 0x09},    //RSVD
	// {0xc8, 0x80},    //RSVD
	// {0x79, 0x02},    //RSVD
	// {0xc8, 0xc0},    //RSVD
	// {0x79, 0x03},    //RSVD
	// {0xc8, 0x40},    //RSVD
	// {0x79, 0x05},    //RSVD
	// {0xc8, 0x30},    //RSVD
	// {0x79, 0x26},    //RSVD		
	// {0x09, 0x02},    //COM2
	// {0x3b, 0x42},    //COM11,x82,//0xc0,//0xc2,	//night mode   167
	
	
	
	   
 };


/***********************************************
    write the register in OV7670
    return 1: successful
    return 0: failed
************************************************/
u8 wrOV7660Reg(u8 regID, u8 regDat)
{
	startSCCB();
	if(0==SCCBwriteByte(0x42))
	{
		stopSCCB();
		return(0);
	}
	DelaySCCB();
  	if(0==SCCBwriteByte(regID))
	{
		stopSCCB();
		return(0);
	}
	DelaySCCB();
  	if(0==SCCBwriteByte(regDat))
	{
		stopSCCB();
		return(0);
	}
  	stopSCCB();
	
  	return(1);
}
/*************************************************
    read the register value in OV7670
    return 1: successful
    return 0:failed
*************************************************/
u8 rdOV7660Reg(u8 regID, u8 *regDat)
{
	//write the register address
	startSCCB();
	if(0==SCCBwriteByte(0x42))
	{
		stopSCCB();
		return(0);
	}
	DelaySCCB();
  	if(0==SCCBwriteByte(regID))
	{
		stopSCCB();
		return(0);
	}
	stopSCCB();
	
	DelaySCCB();
	
	//read the register value
	startSCCB();
	if(0==SCCBwriteByte(0x43))
	{
		stopSCCB();
		return(0);
	}
	DelaySCCB();
  	*regDat=SCCBreadByte();
  	noAck();
  	stopSCCB();
  	return(1);
}


void my_delay_ms(u16 time)//delay some time
{
	u16 i;
	for(;time!=0;time--)
	{
		for(i=0;i<10000;i++);
	}
}

u8 rt;
/********************************
  initialize OV7670
  return 1: successful
  return 0: failed
*********************************/

u8 OV7660_init(void)
{
	u8 temp;
	u8 i;
	
	InitSCCB();// SCCB IO initialize
	temp=0x80;
	wrOV7660Reg(0x12, temp);
	wrOV7660Reg(0x12, temp);
	wrOV7660Reg(0x12, temp);
	if(0==wrOV7660Reg(0x12, temp)) //Reset SCCB
	{
	    return 0;
	}
	my_delay_ms(100);
	
	for(i=0;i<162;i++) //169 for previous settings
	{
		if(0==wrOV7660Reg(ov7670_regs[i][0],ov7670_regs[i][1]))
		{
			return 0;
		}
	}
	my_delay_ms(200);	
	return 0x01; 
} 
